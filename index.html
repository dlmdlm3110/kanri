import React, { useState, useEffect, useRef, useMemo } from 'react';
import { FileText, DollarSign, Users, Settings, Plus, Trash2, Download, Share2, Printer, X, ChevronDown, ChevronUp, Loader, CheckCircle, Sparkles, TrendingUp, Droplets, BarChart } from 'lucide-react';

// --- MOCK/INITIAL DATA (For first-time use) ---
const initialCustomers = [
    { id: 'cust-1', name: '株式会社トータルライフサポート研究所', address: '沖縄県中頭郡読谷村大湾108', paymentTerms: 60 },
    { id: 'cust-2', name: 'デイサービスセンターゆいまーる', address: '沖縄県中頭郡嘉手納町嘉手納258' },
];

const initialLogs = [
    { id: 'log-1', customerId: 'cust-1', date: '2025-07-28', description: '病院送迎 (行き)', passengers: 3, assistanceFee: 1800, fare: 2200, total: 4000, paymentMethod: 'receivable' },
    { id: 'log-2', customerId: 'cust-1', date: '2025-07-28', description: '病院送迎 (帰り)', passengers: 3, assistanceFee: 1800, fare: 2300, total: 4100, paymentMethod: 'receivable' },
    { id: 'log-3', customerId: 'cust-2', date: '2025-07-29', description: 'デイサービス送迎', passengers: 1, assistanceFee: 500, fare: 1500, total: 2000, paymentMethod: 'cash' },
    { id: 'log-4', customerId: null, customerNameOverride: '山田様', date: '2025-07-30', description: '空港送迎', passengers: 1, assistanceFee: 0, fare: 5000, total: 5000, paymentMethod: 'cash' },
];

const initialFuelLogs = [
    { id: 'fuel-1', date: '2025-07-15', cost: 5000, liters: 30.0, odometer: 123450, prevOdometer: 123000 },
];

const initialDailyMetrics = [
    { id: 'metric-1', date: '2025-07-28', totalDistance: 31.5 },
];

const initialSettings = {
    companyName: '介護タクシーいまここ',
    address: '〒904-0313 沖縄県中頭郡読谷村大湾108',
    phone: '090-9011-8526',
    bankInfo: 'コザ信用金庫 嘉手納支店 普通 0272764 サイトウ ユウジ',
    paymentTerms: 30, // Default payment terms in days
};

// --- Helper Functions ---
const getTodayDate = () => new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Tokyo"})).toISOString().split('T')[0];
const getYearMonth = (dateStr) => dateStr.substring(0, 7);

// --- PDF Templates ---
const InvoicePdfTemplate = React.forwardRef(({ invoice, customer, logs, settings }, ref) => {
    if (!invoice || !customer || !logs || !settings) return null;
    const dueDate = new Date(invoice.issueDate);
    const paymentDays = customer.paymentTerms || settings.paymentTerms || 30;
    dueDate.setDate(dueDate.getDate() + paymentDays);
    const dueDateStr = `${dueDate.getFullYear()}.${dueDate.getMonth() + 1}.${dueDate.getDate()}`;

    return (
        <div ref={ref} className="p-8 bg-white text-black font-['MS_Gothic']" style={{ width: '210mm', minHeight: '297mm' }}>
            <h1 className="text-4xl text-center font-bold mb-4">請求書</h1>
            <div className="flex justify-between mb-4">
                <p>発行日: {invoice.issueDate.replace(/-/g, '.')}</p>
                <p>伝票番号: {invoice.invoiceNumber}</p>
            </div>
            <div className="mb-6">
                <h2 className="text-xl border-b-2 border-black pb-2">{customer.name} 御中</h2>
            </div>
            <div className="flex justify-between items-end mb-4">
                <p className="text-lg">下記の通りご請求申し上げます。</p>
                <div className="text-right text-sm">
                    <p className="font-bold">{settings.companyName}</p>
                    <p>{settings.address}</p>
                    <p>電話: {settings.phone}</p>
                </div>
            </div>
            <div className="text-center border-2 border-black py-2 mb-4">
                <span className="text-lg">ご請求金額</span>
                <span className="text-3xl font-bold ml-4">¥ {invoice.totalAmount.toLocaleString()}</span>
            </div>
            <table className="w-full border-collapse text-sm">
                <thead>
                    <tr className="border-y-2 border-black">
                        <th className="p-2 w-1/2 text-left">ご利用</th>
                        <th className="p-2 w-1/6 text-right">乗降</th>
                        <th className="p-2 w-1/6 text-right">運賃</th>
                        <th className="p-2 w-1/6 text-right">料金</th>
                    </tr>
                </thead>
                <tbody>
                    {logs.map(log => (
                        <tr key={log.id} className="border-b border-dotted border-gray-400">
                            <td className="p-2">{log.date.replace(/-/g, '/')} {log.description} {log.passengers}名</td>
                            <td className="p-2 text-right">{log.assistanceFee.toLocaleString()}</td>
                            <td className="p-2 text-right">{log.fare.toLocaleString()}</td>
                            <td className="p-2 text-right">{log.total.toLocaleString()}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
            <div className="flex justify-end mt-2">
                <table className="w-1/2 text-sm">
                    <tbody>
                        <tr className="border-y-2 border-black font-bold">
                            <td className="p-2">合計金額</td>
                            <td className="p-2 text-right text-lg">¥ {invoice.totalAmount.toLocaleString()}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div className="absolute bottom-12 left-8 right-8 text-sm">
                <div className="flex justify-between">
                    <div>
                        <p className="font-bold">振込先</p>
                        <p>{settings.bankInfo}</p>
                    </div>
                    <div>
                        <p className="font-bold">お支払期限</p>
                        <p>{dueDateStr}</p>
                    </div>
                </div>
            </div>
        </div>
    );
});

const ReceiptPdfTemplate = React.forwardRef(({ receipt, customer, settings }, ref) => {
    if (!receipt || !customer || !settings) return null;
    return (
        <div ref={ref} className="p-8 bg-white text-black font-['MS_Gothic']" style={{ width: '210mm', minHeight: '297mm' }}>
            <h1 className="text-4xl text-center font-bold mb-8">領収書</h1>
            <div className="flex justify-between mb-8">
                <p>発行日: {receipt.issueDate.replace(/-/g, '.')}</p>
                <p>領収書No: {receipt.receiptNumber}</p>
            </div>
            <div className="mb-8">
                <h2 className="text-xl border-b-2 border-black pb-2">{customer.name} 御中</h2>
            </div>
            <div className="text-center border-2 border-black py-4 mb-8">
                <span className="text-lg">合計金額</span>
                <span className="text-4xl font-bold ml-4">¥ {receipt.amount.toLocaleString()}-</span>
            </div>
            <div className="mb-8">
                <p className="text-lg">但し、{receipt.proviso}として</p>
                <p className="text-right text-lg mt-2">上記の通り正に領収いたしました。</p>
            </div>
            <div className="flex justify-end">
                <div className="border-2 border-black p-4 text-center">
                    <p className="font-bold">{settings.companyName}</p>
                    <p>{settings.address}</p>
                    <p>電話: {settings.phone}</p>
                </div>
            </div>
        </div>
    );
});


// --- Main App Component ---
export default function App() {
    // State
    const [view, setView] = useState('reports');
    const [customers, setCustomers] = useState(initialCustomers);
    const [logs, setLogs] = useState(initialLogs);
    const [fuelLogs, setFuelLogs] = useState(initialFuelLogs);
    const [dailyMetrics, setDailyMetrics] = useState(initialDailyMetrics);
    const [settings, setSettings] = useState(initialSettings);
    const [invoices, setInvoices] = useState([]);
    const [receipts, setReceipts] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [scriptsReady, setScriptsReady] = useState(false);
    
    // PDF Generation State
    const [invoiceToPrint, setInvoiceToPrint] = useState(null);
    const [receiptToPrint, setReceiptToPrint] = useState(null);
    const invoicePdfRef = useRef();
    const receiptPdfRef = useRef();

    useEffect(() => {
        const loadScript = (src, onReady) => {
            let script = document.querySelector(`script[src="${src}"]`);
            if (!script) {
                script = document.createElement('script'); script.src = src; script.async = true; document.body.appendChild(script);
                script.onload = onReady; script.onerror = () => console.error(`Failed to load script: ${src}`);
            } else if (script.getAttribute('data-loaded')) { onReady(); } else { script.addEventListener('load', onReady); }
        };
        let loadedCount = 0; const totalScripts = 2;
        const onScriptReady = (e) => { e.target.setAttribute('data-loaded', 'true'); loadedCount++; if (loadedCount === totalScripts) { setScriptsReady(true); console.log('All PDF scripts loaded.'); }};
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', onScriptReady);
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', onScriptReady);
    }, []);

    // Handlers
    const handleSaveCustomer = (customer) => {
        if (customer.id) {
            setCustomers(customers.map(c => c.id === customer.id ? customer : c));
        } else {
            setCustomers([...customers, { ...customer, id: `cust-${Date.now()}` }]);
        }
    };
    const handleDeleteCustomer = (id) => setCustomers(customers.filter(c => c.id !== id));

    const handleSaveLog = (log) => {
        if (log.id) {
            setLogs(logs.map(l => l.id === log.id ? log : l));
        } else {
            setLogs([...logs, { ...log, id: `log-${Date.now()}` }]);
        }
    };
    const handleDeleteLog = (id) => setLogs(logs.filter(l => l.id !== id));

    const handleSaveFuelLog = (fuelLog) => {
        if (fuelLog.id) {
            setFuelLogs(fuelLogs.map(fl => fl.id === fuelLog.id ? fuelLog : fl));
        } else {
            setFuelLogs([...fuelLogs, { ...fuelLog, id: `fuel-${Date.now()}` }]);
        }
    };
    const handleDeleteFuelLog = (id) => setFuelLogs(fuelLogs.filter(fl => fl.id !== id));

    const handleSaveDailyMetric = (metric) => {
        const existing = dailyMetrics.find(dm => dm.date === metric.date);
        if (existing) {
            setDailyMetrics(dailyMetrics.map(dm => dm.date === metric.date ? { ...dm, ...metric } : dm));
        } else {
            setDailyMetrics([...dailyMetrics, { ...metric, id: `metric-${Date.now()}` }]);
        }
    };

    const generatePdf = async (ref, fileName, action = 'download') => {
        if (!scriptsReady) {
            console.error("PDF libraries not ready.");
            // Optionally show a user-friendly error message here
            return;
        }
        setIsLoading(true);
        setTimeout(async () => {
            try {
                const { jsPDF } = window.jspdf;
                const html2canvas = window.html2canvas;
                const canvas = await html2canvas(ref.current, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                
                if (action === 'download') {
                    pdf.save(`${fileName}.pdf`);
                } else { // print
                    pdf.autoPrint();
                    window.open(pdf.output('bloburl'), '_blank');
                }
            } catch (error) {
                console.error("PDF generation failed:", error);
            } finally {
                setInvoiceToPrint(null);
                setReceiptToPrint(null);
                setIsLoading(false);
            }
        }, 100);
    };

    const handlePrintInvoice = (invoice) => {
        const customer = customers.find(c => c.id === invoice.customerId);
        const invoiceLogs = invoice.logIds.map(id => logs.find(l => l.id === id));
        setInvoiceToPrint({ invoice, customer, logs: invoiceLogs, settings });
        setTimeout(() => generatePdf(invoicePdfRef, `請求書_${customer.name}_${invoice.billingMonth}`, 'print'), 100);
    };

    const handlePrintReceipt = (receipt) => {
        const customer = customers.find(c => c.id === receipt.customerId);
        setReceiptToPrint({ receipt, customer, settings });
        setTimeout(() => generatePdf(receiptPdfRef, `領収書_${customer.name}_${receipt.issueDate}`, 'print'), 100);
    };

    return (
        <div className="bg-gray-100 text-gray-800 min-h-screen font-sans">
            {isLoading && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><Loader className="animate-spin text-white" size={48}/></div>}
            
            <header className="bg-white shadow-md sticky top-0 z-40">
                <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 className="text-xl font-bold text-gray-700">介護タクシー請求管理</h1>
                    <div className="flex gap-2">
                        <button onClick={() => setView('reports')} className={`p-2 rounded-full ${view === 'reports' ? 'bg-cyan-100 text-cyan-600' : 'text-gray-500'}`}><TrendingUp/></button>
                        <button onClick={() => setView('logs')} className={`p-2 rounded-full ${view === 'logs' ? 'bg-cyan-100 text-cyan-600' : 'text-gray-500'}`}><FileText/></button>
                        <button onClick={() => setView('invoices')} className={`p-2 rounded-full ${view === 'invoices' ? 'bg-cyan-100 text-cyan-600' : 'text-gray-500'}`}><DollarSign/></button>
                        <button onClick={() => setView('customers')} className={`p-2 rounded-full ${view === 'customers' ? 'bg-cyan-100 text-cyan-600' : 'text-gray-500'}`}><Users/></button>
                        <button onClick={() => setView('settings')} className={`p-2 rounded-full ${view === 'settings' ? 'bg-cyan-100 text-cyan-600' : 'text-gray-500'}`}><Settings/></button>
                    </div>
                </div>
            </header>

            <main className="container mx-auto p-4">
                {view === 'reports' && <ReportManager logs={logs} dailyMetrics={dailyMetrics} onSaveMetric={handleSaveDailyMetric} />}
                {view === 'logs' && <TransportLogManager logs={logs} customers={customers} settings={settings} onSave={handleSaveLog} onDelete={handleDeleteLog} />}
                {view === 'invoices' && <InvoiceManager invoices={invoices} setInvoices={setInvoices} receipts={receipts} setReceipts={setReceipts} logs={logs} customers={customers} onPrintInvoice={handlePrintInvoice} onPrintReceipt={handlePrintReceipt}/>}
                {view === 'customers' && <CustomerManager customers={customers} settings={settings} onSave={handleSaveCustomer} onDelete={handleDeleteCustomer} />}
                {view === 'settings' && <SettingsManager settings={settings} setSettings={setSettings} />}
            </main>

            <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                <InvoicePdfTemplate ref={invoicePdfRef} {...invoiceToPrint} />
                <ReceiptPdfTemplate ref={receiptPdfRef} {...receiptToPrint} />
            </div>
        </div>
    );
}

// --- Sub Components ---
function ReportManager({ logs, dailyMetrics, onSaveMetric }) {
    const currentYear = new Date().getFullYear();
    const [fiscalYear, setFiscalYear] = useState(new Date().getMonth() < 3 ? currentYear - 1 : currentYear);
    const [selectedDate, setSelectedDate] = useState(getTodayDate());
    const [dailyDistance, setDailyDistance] = useState('');

    useEffect(() => {
        const metric = dailyMetrics.find(m => m.date === selectedDate);
        setDailyDistance(metric?.totalDistance || '');
    }, [selectedDate, dailyMetrics]);

    const handleDistanceSave = () => {
        onSaveMetric({ date: selectedDate, totalDistance: Number(dailyDistance) });
    };

    const fiscalYearData = useMemo(() => {
        const start = new Date(`${fiscalYear}-04-01`);
        const end = new Date(`${fiscalYear + 1}-03-31`);
        const filteredLogs = logs.filter(l => {
            const logDate = new Date(l.date);
            return logDate >= start && logDate <= end;
        });

        const totalTrips = filteredLogs.length;
        const totalPassengers = filteredLogs.reduce((sum, l) => sum + l.passengers, 0);
        const totalSales = filteredLogs.reduce((sum, l) => sum + l.total, 0);

        return { totalTrips, totalPassengers, totalSales };
    }, [fiscalYear, logs]);
    
    const dailyData = useMemo(() => {
        const filteredLogs = logs.filter(l => l.date === selectedDate);
        const trips = filteredLogs.length;
        const passengers = filteredLogs.reduce((sum, l) => sum + l.passengers, 0);
        const sales = filteredLogs.reduce((sum, l) => sum + l.total, 0);
        return { trips, passengers, sales };
    }, [selectedDate, logs]);

    const yearOptions = Array.from({length: 10}, (_, i) => currentYear - i);

    return (
        <div>
            <h2 className="text-2xl font-bold mb-4">日報・輸送実績</h2>
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
                <h3 className="text-xl font-bold mb-2">日報</h3>
                <div className="mb-4">
                    <label className="block text-sm font-medium">日付</label>
                    <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="p-2 border rounded-md"/>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">運送回数</p><p className="text-xl font-bold">{dailyData.trips.toLocaleString()} 回</p></div>
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">乗車人数</p><p className="text-xl font-bold">{dailyData.passengers.toLocaleString()} 人</p></div>
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">売上</p><p className="text-xl font-bold">¥{dailyData.sales.toLocaleString()}</p></div>
                    <div className="bg-gray-50 p-3 rounded-md">
                        <label className="block text-sm text-center text-gray-500">総走行距離 (km)</label>
                        <div className="flex items-center gap-2 mt-1">
                           <input type="number" step="0.1" value={dailyDistance} onChange={e => setDailyDistance(e.target.value)} className="w-full p-1 border rounded-md text-center"/>
                           <button onClick={handleDistanceSave} className="bg-cyan-500 text-white p-2 rounded-md"><CheckCircle size={16}/></button>
                        </div>
                    </div>
                </div>
            </div>
            <div className="bg-white p-4 rounded-lg shadow">
                 <h3 className="text-xl font-bold mb-2">輸送実績報告書</h3>
                <div className="mb-4">
                    <label className="block text-sm font-medium">対象年度</label>
                    <select value={fiscalYear} onChange={e => setFiscalYear(Number(e.target.value))} className="p-2 border rounded-md">
                        {yearOptions.map(year => <option key={year} value={year}>{year}年度</option>)}
                    </select>
                    <p className="text-xs text-gray-500 mt-1">{fiscalYear}年4月1日〜{fiscalYear+1}年3月31日</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">総運送回数</p><p className="text-xl font-bold">{fiscalYearData.totalTrips.toLocaleString()} 回</p></div>
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">総乗車人数</p><p className="text-xl font-bold">{fiscalYearData.totalPassengers.toLocaleString()} 人</p></div>
                    <div className="bg-gray-50 p-3 rounded-md text-center"><p className="text-sm text-gray-500">総売上</p><p className="text-xl font-bold">¥{fiscalYearData.totalSales.toLocaleString()}</p></div>
                </div>
            </div>
        </div>
    );
}

function TransportLogManager({ logs, customers, settings, onSave, onDelete }) {
    const [showForm, setShowForm] = useState(false);
    const [logToEdit, setLogToEdit] = useState(null);
    const [activeCustomerId, setActiveCustomerId] = useState('all');

    const handleEdit = (log) => {
        setLogToEdit(log);
        setShowForm(true);
    };
    
    const handleAddNew = () => {
        setLogToEdit(null);
        setShowForm(true);
    };

    const filteredLogs = useMemo(() => {
        if (activeCustomerId === 'all') {
            return logs;
        }
        return logs.filter(log => log.customerId === activeCustomerId);
    }, [logs, activeCustomerId]);

    return (
        <div>
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">売上記録</h2>
                {!showForm && <button onClick={handleAddNew} className="bg-cyan-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Plus size={16}/>新規記録</button>}
            </div>
            
            {showForm ? (
                <TransportLogForm customers={customers} settings={settings} onSave={(log) => { onSave(log); setShowForm(false); }} onCancel={() => setShowForm(false)} logToEdit={logToEdit} allLogs={logs} activeCustomerId={activeCustomerId} />
            ) : (
                <>
                    <div className="mb-4 overflow-x-auto whitespace-nowrap pb-2">
                        <button onClick={() => setActiveCustomerId('all')} className={`px-4 py-2 mr-2 rounded-full text-sm font-semibold ${activeCustomerId === 'all' ? 'bg-cyan-500 text-white shadow' : 'bg-white text-gray-700'}`}>すべて</button>
                        {customers.map(customer => (
                            <button key={customer.id} onClick={() => setActiveCustomerId(customer.id)} className={`px-4 py-2 mr-2 rounded-full text-sm font-semibold ${activeCustomerId === customer.id ? 'bg-cyan-500 text-white shadow' : 'bg-white text-gray-700'}`}>
                                {customer.name}
                            </button>
                        ))}
                    </div>
                    <div className="space-y-3">
                        {filteredLogs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(log => {
                            const customer = log.customerId ? customers.find(c => c.id === log.customerId) : null;
                            const displayName = customer ? customer.name : log.customerNameOverride;
                            return (
                                <div key={log.id} className="bg-white p-4 rounded-lg shadow">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="font-bold">{log.date}</p>
                                            <p className="text-gray-600">{displayName}</p>
                                            <p className="text-sm text-gray-500">{log.description}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="font-bold text-lg">¥{log.total.toLocaleString()}</p>
                                            <div className="flex gap-2 mt-2">
                                                <button onClick={() => handleEdit(log)} className="text-blue-500"><FileText size={18}/></button>
                                                <button onClick={() => onDelete(log.id)} className="text-red-500"><Trash2 size={18}/></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                         {filteredLogs.length === 0 && <p className="text-center text-gray-500 py-8">この顧客の記録はありません。</p>}
                    </div>
                </>
            )}
        </div>
    );
}

function TransportLogForm({ customers, settings, onSave, onCancel, logToEdit, allLogs, activeCustomerId }) {
    const [date, setDate] = useState(getTodayDate());
    const [customerName, setCustomerName] = useState('');
    const [description, setDescription] = useState('');
    const [passengers, setPassengers] = useState(1);
    const [fare, setFare] = useState('');
    const [assistanceFee, setAssistanceFee] = useState('');
    const [paymentMethod, setPaymentMethod] = useState('receivable');
    const [aiSuggestions, setAiSuggestions] = useState([]);
    const [isAiLoading, setIsAiLoading] = useState(false);

    const descriptionHistory = useMemo(() => {
        const descriptions = allLogs.map(log => log.description.trim()).filter(Boolean);
        return [...new Set(descriptions)];
    }, [allLogs]);

    useEffect(() => {
        if (logToEdit) {
            const customer = logToEdit.customerId ? customers.find(c => c.id === logToEdit.customerId) : null;
            setDate(logToEdit.date);
            setCustomerName(customer ? customer.name : logToEdit.customerNameOverride || '');
            setDescription(logToEdit.description);
            setPassengers(logToEdit.passengers);
            setFare(logToEdit.fare);
            setAssistanceFee(logToEdit.assistanceFee);
            setPaymentMethod(logToEdit.paymentMethod || 'receivable');
        } else {
            const activeCustomer = customers.find(c => c.id === activeCustomerId);
            if (activeCustomer) {
                setCustomerName(activeCustomer.name);
            }
        }
    }, [logToEdit, customers, activeCustomerId]);

    const isRegisteredCustomer = useMemo(() => customers.some(c => c.name === customerName), [customers, customerName]);

    useEffect(() => {
        if (!isRegisteredCustomer) {
            setPaymentMethod('cash');
        }
    }, [isRegisteredCustomer]);

    const total = (Number(assistanceFee) || 0) + (Number(fare) || 0);

    const handleGenerateSuggestions = async () => {
        if (!customerName) return;
        setIsAiLoading(true);
        setAiSuggestions([]);

        const prompt = `「${customerName}」向けの介護タクシー送迎記録の摘要を3つ提案してください。一般的な例を参考に、簡潔に記述してください。例: 病院送迎 (行き), デイサービス送迎, 買い物代行。提案はコンマ区切りで返してください。`;
        
        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                const text = result.candidates[0].content.parts[0].text;
                setAiSuggestions(text.split(',').map(s => s.trim()).filter(Boolean));
            }
        } catch (error) {
            console.error("AI suggestion generation failed:", error);
        } finally {
            setIsAiLoading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const customer = customers.find(c => c.name === customerName);
        const logData = {
            date,
            description,
            passengers: Number(passengers),
            fare: Number(fare),
            assistanceFee: Number(assistanceFee),
            total,
            customerId: customer ? customer.id : null,
            customerNameOverride: customer ? null : customerName,
            paymentMethod: customer ? paymentMethod : 'cash',
        };
        onSave({ ...logData, id: logToEdit?.id });
    };

    return (
        <form onSubmit={handleSubmit} className="bg-white p-4 rounded-lg shadow space-y-4">
            <h3 className="text-xl font-bold">{logToEdit ? '記録の編集' : '新規記録'}</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium">日付</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-2 border rounded-md" required/></div>
                <div><label className="block text-sm font-medium">お客様</label><input type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} list="customer-list" className="w-full p-2 border rounded-md" required/><datalist id="customer-list">{customers.map(c => <option key={c.id} value={c.name} />)}</datalist></div>
            </div>
            <div>
                <label className="block text-sm font-medium">摘要 (例: 病院送迎)</label>
                <div className="flex items-center gap-2">
                    <input type="text" value={description} onChange={e => setDescription(e.target.value)} list="description-history" className="w-full p-2 border rounded-md" required/>
                    <datalist id="description-history">
                        {descriptionHistory.map(desc => <option key={desc} value={desc} />)}
                    </datalist>
                    <button type="button" onClick={handleGenerateSuggestions} disabled={isAiLoading || !customerName} className="p-2 bg-purple-100 text-purple-600 rounded-full disabled:opacity-50">
                        {isAiLoading ? <Loader size={20} className="animate-spin" /> : <Sparkles size={20}/>}
                    </button>
                </div>
                {aiSuggestions.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                        {aiSuggestions.map(suggestion => (
                            <button key={suggestion} type="button" onClick={() => setDescription(suggestion)} className="bg-purple-50 text-purple-700 px-2 py-1 text-sm rounded-md hover:bg-purple-100">{suggestion}</button>
                        ))}
                    </div>
                )}
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                <div><label className="block text-sm font-medium">人数</label><input type="number" value={passengers} onChange={e => setPassengers(e.target.value)} className="w-full p-2 border rounded-md" min="1" required/></div>
                <div><label className="block text-sm font-medium">乗降介助料</label><input type="number" value={assistanceFee} onChange={e => setAssistanceFee(e.target.value)} className="w-full p-2 border rounded-md" required/></div>
                <div><label className="block text-sm font-medium">運賃</label><input type="number" value={fare} onChange={e => setFare(e.target.value)} className="w-full p-2 border rounded-md" required/></div>
                <div><label className="block text-sm font-medium">料金</label><p className="p-2 bg-gray-100 rounded-md text-right font-bold">¥{total.toLocaleString()}</p></div>
            </div>
             <div><label className="block text-sm font-medium">売上区分</label><div className="flex gap-2 mt-1"><button type="button" onClick={() => setPaymentMethod('receivable')} disabled={!isRegisteredCustomer} className={`flex-1 py-2 rounded-md ${paymentMethod === 'receivable' ? 'bg-cyan-500 text-white' : 'bg-gray-200'} disabled:bg-gray-300 disabled:cursor-not-allowed`}>売掛金</button><button type="button" onClick={() => setPaymentMethod('cash')} className={`flex-1 py-2 rounded-md ${paymentMethod === 'cash' ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>現金</button></div></div>
            <div className="flex justify-end gap-3"><button type="button" onClick={onCancel} className="bg-gray-200 px-4 py-2 rounded-lg">キャンセル</button><button type="submit" className="bg-cyan-500 text-white px-4 py-2 rounded-lg">保存</button></div>
        </form>
    );
}

function InvoiceManager({ invoices, setInvoices, receipts, setReceipts, logs, customers, onPrintInvoice, onPrintReceipt }) {
    const [billingMonth, setBillingMonth] = useState(getYearMonth(getTodayDate()));

    const handleCreateInvoice = (customerId, totalAmount, logIds) => {
        const invoiceNumber = `${billingMonth.replace('-', '')}-${customerId.slice(-4)}`;
        const newInvoice = { id: `inv-${Date.now()}`, invoiceNumber, customerId, billingMonth, totalAmount, logIds, issueDate: getTodayDate(), status: 'unpaid' };
        setInvoices([...invoices, newInvoice]);
    };

    const handleCreateReceipt = (invoice) => {
        const receiptNumber = `R-${invoice.invoiceNumber}`;
        const newReceipt = { id: `rec-${Date.now()}`, receiptNumber, customerId: invoice.customerId, amount: invoice.totalAmount, issueDate: getTodayDate(), proviso: '介護タクシー利用料として', invoiceId: invoice.id };
        setReceipts([...receipts, newReceipt]);
        setInvoices(invoices.map(inv => inv.id === invoice.id ? { ...inv, status: 'paid' } : inv));
    };

    const billableCustomers = useMemo(() => {
        const logsInMonth = logs.filter(log => getYearMonth(log.date) === billingMonth && log.paymentMethod === 'receivable');
        
        const invoicedLogIds = invoices
            .filter(inv => inv.billingMonth === billingMonth)
            .flatMap(inv => inv.logIds);

        const unbilledLogs = logsInMonth.filter(log => !invoicedLogIds.includes(log.id));
        
        const customerLogMap = unbilledLogs.reduce((acc, log) => {
            if (!acc[log.customerId]) acc[log.customerId] = [];
            acc[log.customerId].push(log);
            return acc;
        }, {});

        return Object.keys(customerLogMap).map(customerId => {
            const customerLogs = customerLogMap[customerId];
            const total = customerLogs.reduce((sum, log) => sum + log.total, 0);
            const customer = customers.find(c => c.id === customerId);
            return { customerId, name: customer?.name, total, logIds: customerLogs.map(l => l.id) };
        }).filter(c => c.name && c.total > 0);
    }, [billingMonth, logs, customers, invoices]);

    return (
        <div>
            <h2 className="text-2xl font-bold mb-4">請求書・領収書発行</h2>
            <div className="mb-6"><label className="block text-sm font-medium">請求月</label><input type="month" value={billingMonth} onChange={e => setBillingMonth(e.target.value)} className="p-2 border rounded-md"/></div>
            <div className="mb-6">
                <h3 className="text-xl font-bold mb-2">請求可能な顧客 (売掛金)</h3>
                <div className="space-y-3">
                    {billableCustomers.map(cust => (
                        <div key={cust.customerId} className="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <div><p className="font-bold">{cust.name}</p><p className="text-gray-600">¥{cust.total.toLocaleString()}</p></div>
                            <button onClick={() => handleCreateInvoice(cust.customerId, cust.total, cust.logIds)} className="bg-cyan-500 text-white px-4 py-2 rounded-lg">請求書を作成</button>
                        </div>
                    ))}
                    {billableCustomers.length === 0 && <p className="text-gray-500">この月の請求対象はありません。</p>}
                </div>
            </div>
            <div>
                <h3 className="text-xl font-bold mb-2">発行済みの書類</h3>
                <div className="space-y-3">
                    {invoices.filter(inv => inv.billingMonth === billingMonth).map(invoice => {
                        const customer = customers.find(c => c.id === invoice.customerId);
                        const receipt = receipts.find(r => r.invoiceId === invoice.id);
                        return (
                            <div key={invoice.id} className={`bg-white p-4 rounded-lg shadow`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="font-bold">{customer?.name}</p>
                                        <p className="text-gray-600">請求額: ¥{invoice.totalAmount.toLocaleString()}</p>
                                        <p className={`text-sm font-bold ${invoice.status === 'paid' ? 'text-green-600' : 'text-orange-600'}`}>{invoice.status === 'paid' ? '支払済' : '未払'}</p>
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        <button onClick={() => onPrintInvoice(invoice)} className="bg-gray-200 px-3 py-1 rounded-md text-sm flex items-center gap-2"><Printer size={14}/>請求書</button>
                                        {invoice.status === 'paid' && receipt && <button onClick={() => onPrintReceipt(receipt)} className="bg-green-100 text-green-700 px-3 py-1 rounded-md text-sm flex items-center gap-2"><Printer size={14}/>領収書</button>}
                                        {invoice.status === 'unpaid' && <button onClick={() => handleCreateReceipt(invoice)} className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm flex items-center gap-2"><CheckCircle size={14}/>領収書を発行</button>}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
}

function CustomerManager({ customers, settings, onSave, onDelete }) {
    const [showForm, setShowForm] = useState(false);
    const [customerToEdit, setCustomerToEdit] = useState(null);
    return (
        <div>
            <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">顧客管理</h2><button onClick={() => { setCustomerToEdit(null); setShowForm(true); }} className="bg-cyan-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Plus size={16}/>新規顧客</button></div>
            {showForm ? (<CustomerForm onSave={(c) => { onSave(c); setShowForm(false); }} onCancel={() => setShowForm(false)} customerToEdit={customerToEdit} settings={settings} />) : 
            (<div className="space-y-3">{customers.map(c => (<div key={c.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center"><div><p className="font-bold">{c.name}</p><p className="text-sm text-gray-500">{c.address}</p></div><div className="flex gap-2"><button onClick={() => { setCustomerToEdit(c); setShowForm(true); }} className="text-blue-500"><FileText size={18}/></button><button onClick={() => onDelete(c.id)} className="text-red-500"><Trash2 size={18}/></button></div></div>))}</div>)}
        </div>
    );
}

function CustomerForm({ onSave, onCancel, customerToEdit, settings }) {
    const [name, setName] = useState('');
    const [address, setAddress] = useState('');
    const [assistanceFee, setAssistanceFee] = useState('');
    const [paymentTerms, setPaymentTerms] = useState('');

    useEffect(() => { 
        if (customerToEdit) { 
            setName(customerToEdit.name); 
            setAddress(customerToEdit.address);
            setAssistanceFee(customerToEdit.assistanceFeePerPerson || '');
            setPaymentTerms(customerToEdit.paymentTerms || '');
        } else { 
            setName(''); 
            setAddress('');
            setAssistanceFee('');
            setPaymentTerms('');
        } 
    }, [customerToEdit]);
    
    const handleSubmit = (e) => { 
        e.preventDefault(); 
        onSave({ 
            id: customerToEdit?.id, 
            name, 
            address, 
            assistanceFeePerPerson: Number(assistanceFee) || null,
            paymentTerms: Number(paymentTerms) || null
        }); 
    };
    
    return (
        <form onSubmit={handleSubmit} className="bg-white p-4 rounded-lg shadow space-y-4">
            <h3 className="text-xl font-bold">{customerToEdit ? '顧客情報の編集' : '新規顧客登録'}</h3>
            <div><label className="block text-sm font-medium">顧客名</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded-md" required/></div>
            <div><label className="block text-sm font-medium">住所</label><input type="text" value={address} onChange={e => setAddress(e.target.value)} className="w-full p-2 border rounded-md"/></div>
            <div><label className="block text-sm font-medium">基本乗降介助料 (1名あたり)</label><input type="number" value={assistanceFee} onChange={e => setAssistanceFee(e.target.value)} placeholder={`基本設定: ${settings.assistanceFeePerPerson}円`} className="w-full p-2 border rounded-md"/></div>
            <div><label className="block text-sm font-medium">お支払期限 (請求書発行後の日数)</label><input type="number" value={paymentTerms} onChange={e => setPaymentTerms(e.target.value)} placeholder={`基本設定: ${settings.paymentTerms}日`} className="w-full p-2 border rounded-md"/></div>
            <div className="flex justify-end gap-3"><button type="button" onClick={onCancel} className="bg-gray-200 px-4 py-2 rounded-lg">キャンセル</button><button type="submit" className="bg-cyan-500 text-white px-4 py-2 rounded-lg">保存</button></div>
        </form>
    );
}

function SettingsManager({ settings, setSettings }) {
    const [formData, setFormData] = useState(settings);
    const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
    const handleSave = () => setSettings(formData);
    return (
        <div className="bg-white p-4 rounded-lg shadow max-w-2xl mx-auto">
            <h2 className="text-2xl font-bold mb-4">事業者情報設定</h2>
            <div className="space-y-4">
                <div><label className="block text-sm font-medium">事業者名</label><input type="text" name="companyName" value={formData.companyName} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                <div><label className="block text-sm font-medium">住所</label><input type="text" name="address" value={formData.address} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                <div><label className="block text-sm font-medium">電話番号</label><input type="text" name="phone" value={formData.phone} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                <div><label className="block text-sm font-medium">振込先情報</label><textarea name="bankInfo" value={formData.bankInfo} onChange={handleChange} className="w-full p-2 border rounded-md" rows="3"></textarea></div>
                <div><label className="block text-sm font-medium">基本乗降介助料 (1名あたり)</label><input type="number" name="assistanceFeePerPerson" value={formData.assistanceFeePerPerson} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                <div><label className="block text-sm font-medium">基本お支払期限 (請求書発行後の日数)</label><input type="number" name="paymentTerms" value={formData.paymentTerms} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                <div className="text-right"><button onClick={handleSave} className="bg-cyan-500 text-white px-6 py-2 rounded-lg">保存</button></div>
            </div>
        </div>
    );
}
